module.exports=Readable;var isArray=require("isarray");var Buffer=require("buffer").Buffer;Readable.ReadableState=ReadableState;var EE=require("events").EventEmitter;if(!EE.listenerCount){EE.listenerCount=function(b,a){return b.listeners(a).length}}var Stream=require("stream");var util=require("core-util-is");util.inherits=require("inherits");var StringDecoder;util.inherits(Readable,Stream);function ReadableState(a,c){a=a||{};var b=a.highWaterMark;this.highWaterMark=(b||b===0)?b:16*1024;this.highWaterMark=~~this.highWaterMark;this.buffer=[];this.length=0;this.pipes=null;this.pipesCount=0;this.flowing=false;this.ended=false;this.endEmitted=false;this.reading=false;this.calledRead=false;this.sync=true;this.needReadable=false;this.emittedReadable=false;this.readableListening=false;this.objectMode=!!a.objectMode;this.defaultEncoding=a.defaultEncoding||"utf8";this.ranOut=false;this.awaitDrain=0;this.readingMore=false;this.decoder=null;this.encoding=null;if(a.encoding){if(!StringDecoder){StringDecoder=require("string_decoder/").StringDecoder}this.decoder=new StringDecoder(a.encoding);this.encoding=a.encoding}}function Readable(a){if(!(this instanceof Readable)){return new Readable(a)}this._readableState=new ReadableState(a,this);this.readable=true;Stream.call(this)}Readable.prototype.push=function(a,b){var c=this._readableState;if(typeof a==="string"&&!c.objectMode){b=b||c.defaultEncoding;if(b!==c.encoding){a=new Buffer(a,b);b=""}}return readableAddChunk(this,c,a,b,false)};Readable.prototype.unshift=function(a){var b=this._readableState;return readableAddChunk(this,b,a,"",true)};function readableAddChunk(g,d,a,c,b){var h=chunkInvalid(d,a);if(h){g.emit("error",h)}else{if(a===null||a===undefined){d.reading=false;if(!d.ended){onEofChunk(g,d)}}else{if(d.objectMode||a&&a.length>0){if(d.ended&&!b){var f=new Error("stream.push() after EOF");g.emit("error",f)}else{if(d.endEmitted&&b){var f=new Error("stream.unshift() after end event");g.emit("error",f)}else{if(d.decoder&&!b&&!c){a=d.decoder.write(a)}d.length+=d.objectMode?1:a.length;if(b){d.buffer.unshift(a)}else{d.reading=false;d.buffer.push(a)}if(d.needReadable){emitReadable(g)}maybeReadMore(g,d)}}}else{if(!b){d.reading=false}}}}return needMoreData(d)}function needMoreData(a){return !a.ended&&(a.needReadable||a.length<a.highWaterMark||a.length===0)}Readable.prototype.setEncoding=function(a){if(!StringDecoder){StringDecoder=require("string_decoder/").StringDecoder}this._readableState.decoder=new StringDecoder(a);this._readableState.encoding=a};var MAX_HWM=8388608;function roundUpToNextPowerOf2(b){if(b>=MAX_HWM){b=MAX_HWM}else{b--;for(var a=1;a<32;a<<=1){b|=b>>a}b++}return b}function howMuchToRead(b,a){if(a.length===0&&a.ended){return 0}if(a.objectMode){return b===0?0:1}if(b===null||isNaN(b)){if(a.flowing&&a.buffer.length){return a.buffer[0].length}else{return a.length}}if(b<=0){return 0}if(b>a.highWaterMark){a.highWaterMark=roundUpToNextPowerOf2(b)}if(b>a.length){if(!a.ended){a.needReadable=true;return 0}else{return a.length}}return b}Readable.prototype.read=function(e){var d=this._readableState;d.calledRead=true;var c=e;var b;if(typeof e!=="number"||e>0){d.emittedReadable=false}if(e===0&&d.needReadable&&(d.length>=d.highWaterMark||d.ended)){emitReadable(this);return null}e=howMuchToRead(e,d);if(e===0&&d.ended){b=null;if(d.length>0&&d.decoder){b=fromList(e,d);d.length-=b.length}if(d.length===0){endReadable(this)}return b}var a=d.needReadable;if(d.length-e<=d.highWaterMark){a=true}if(d.ended||d.reading){a=false}if(a){d.reading=true;d.sync=true;if(d.length===0){d.needReadable=true}this._read(d.highWaterMark);d.sync=false}if(a&&!d.reading){e=howMuchToRead(c,d)}if(e>0){b=fromList(e,d)}else{b=null}if(b===null){d.needReadable=true;e=0}d.length-=e;if(d.length===0&&!d.ended){d.needReadable=true}if(d.ended&&!d.endEmitted&&d.length===0){endReadable(this)}return b};function chunkInvalid(b,a){var c=null;if(!Buffer.isBuffer(a)&&"string"!==typeof a&&a!==null&&a!==undefined&&!b.objectMode){c=new TypeError("Invalid non-string/buffer chunk")}return c}function onEofChunk(c,b){if(b.decoder&&!b.ended){var a=b.decoder.end();if(a&&a.length){b.buffer.push(a);b.length+=b.objectMode?1:a.length}}b.ended=true;if(b.length>0){emitReadable(c)}else{endReadable(c)}}function emitReadable(b){var a=b._readableState;a.needReadable=false;if(a.emittedReadable){return}a.emittedReadable=true;if(a.sync){process.nextTick(function(){emitReadable_(b)})}else{emitReadable_(b)}}function emitReadable_(a){a.emit("readable")}function maybeReadMore(b,a){if(!a.readingMore){a.readingMore=true;process.nextTick(function(){maybeReadMore_(b,a)})}}function maybeReadMore_(c,b){var a=b.length;while(!b.reading&&!b.flowing&&!b.ended&&b.length<b.highWaterMark){c.read(0);if(a===b.length){break}else{a=b.length}}b.readingMore=false}Readable.prototype._read=function(a){this.emit("error",new Error("not implemented"))};Readable.prototype.pipe=function(l,j){var a=this;var b=this._readableState;switch(b.pipesCount){case 0:b.pipes=l;break;case 1:b.pipes=[b.pipes,l];break;default:b.pipes.push(l);break}b.pipesCount+=1;var k=(!j||j.end!==false)&&l!==process.stdout&&l!==process.stderr;var d=k?n:c;if(b.endEmitted){process.nextTick(d)}else{a.once("end",d)}l.on("unpipe",g);function g(o){if(o!==a){return}c()}function n(){l.end()}var e=pipeOnDrain(a);l.on("drain",e);function c(){l.removeListener("close",m);l.removeListener("finish",f);l.removeListener("drain",e);l.removeListener("error",i);l.removeListener("unpipe",g);a.removeListener("end",n);a.removeListener("end",c);if(!l._writableState||l._writableState.needDrain){e()}}function i(o){h();l.removeListener("error",i);if(EE.listenerCount(l,"error")===0){l.emit("error",o)}}if(!l._events||!l._events.error){l.on("error",i)}else{if(isArray(l._events.error)){l._events.error.unshift(i)}else{l._events.error=[i,l._events.error]}}function m(){l.removeListener("finish",f);h()}l.once("close",m);function f(){l.removeListener("close",m);h()}l.once("finish",f);function h(){a.unpipe(l)}l.emit("pipe",a);if(!b.flowing){this.on("readable",pipeOnReadable);b.flowing=true;process.nextTick(function(){flow(a)})}return l};function pipeOnDrain(a){return function(){var b=this;var c=a._readableState;c.awaitDrain--;if(c.awaitDrain===0){flow(a)}}}function flow(d){var c=d._readableState;var a;c.awaitDrain=0;function b(f,g,h){var e=f.write(a);if(false===e){c.awaitDrain++}}while(c.pipesCount&&null!==(a=d.read())){if(c.pipesCount===1){b(c.pipes,0,null)}else{forEach(c.pipes,b)}d.emit("data",a);if(c.awaitDrain>0){return}}if(c.pipesCount===0){c.flowing=false;if(EE.listenerCount(d,"data")>0){emitDataEvents(d)}return}c.ranOut=true}function pipeOnReadable(){if(this._readableState.ranOut){this._readableState.ranOut=false;flow(this)}}Readable.prototype.unpipe=function(b){var d=this._readableState;if(d.pipesCount===0){return this}if(d.pipesCount===1){if(b&&b!==d.pipes){return this}if(!b){b=d.pipes}d.pipes=null;d.pipesCount=0;this.removeListener("readable",pipeOnReadable);d.flowing=false;if(b){b.emit("unpipe",this)}return this}if(!b){var e=d.pipes;var a=d.pipesCount;d.pipes=null;d.pipesCount=0;this.removeListener("readable",pipeOnReadable);d.flowing=false;for(var c=0;c<a;c++){e[c].emit("unpipe",this)}return this}var c=indexOf(d.pipes,b);if(c===-1){return this}d.pipes.splice(c,1);d.pipesCount-=1;if(d.pipesCount===1){d.pipes=d.pipes[0]}b.emit("unpipe",this);return this};Readable.prototype.on=function(c,b){var a=Stream.prototype.on.call(this,c,b);if(c==="data"&&!this._readableState.flowing){emitDataEvents(this)}if(c==="readable"&&this.readable){var d=this._readableState;if(!d.readableListening){d.readableListening=true;d.emittedReadable=false;d.needReadable=true;if(!d.reading){this.read(0)}else{if(d.length){emitReadable(this,d)}}}}return a};Readable.prototype.addListener=Readable.prototype.on;Readable.prototype.resume=function(){emitDataEvents(this);this.read(0);this.emit("resume")};Readable.prototype.pause=function(){emitDataEvents(this,true);this.emit("pause")};function emitDataEvents(e,c){var d=e._readableState;if(d.flowing){throw new Error("Cannot switch to old mode now.")}var b=c||false;var a=false;e.readable=true;e.pipe=Stream.prototype.pipe;e.on=e.addListener=Stream.prototype.on;e.on("readable",function(){a=true;var f;while(!b&&(null!==(f=e.read()))){e.emit("data",f)}if(f===null){a=false;e._readableState.needReadable=true}});e.pause=function(){b=true;this.emit("pause")};e.resume=function(){b=false;if(a){process.nextTick(function(){e.emit("readable")})}else{this.read(0)}this.emit("resume")};e.emit("readable")}Readable.prototype.wrap=function(f){var e=this._readableState;var d=false;var a=this;f.on("end",function(){if(e.decoder&&!e.ended){var g=e.decoder.end();if(g&&g.length){a.push(g)}}a.push(null)});f.on("data",function(h){if(e.decoder){h=e.decoder.write(h)}if(e.objectMode&&(h===null||h===undefined)){return}else{if(!e.objectMode&&(!h||!h.length)){return}}var g=a.push(h);if(!g){d=true;f.pause()}});for(var c in f){if(typeof f[c]==="function"&&typeof this[c]==="undefined"){this[c]=function(g){return function(){return f[g].apply(f,arguments)}}(c)}}var b=["error","close","destroy","pause","resume"];forEach(b,function(g){f.on(g,a.emit.bind(a,g))});a._read=function(g){if(d){d=false;f.resume()}};return a};Readable._fromList=fromList;function fromList(e,a){var j=a.buffer;var b=a.length;var m=!!a.decoder;var p=!!a.objectMode;var k;if(j.length===0){return null}if(b===0){k=null}else{if(p){k=j.shift()}else{if(!e||e>=b){if(m){k=j.join("")}else{k=Buffer.concat(j,b)}j.length=0}else{if(e<j[0].length){var d=j[0];k=d.slice(0,e);j[0]=d.slice(e)}else{if(e===j[0].length){k=j.shift()}else{if(m){k=""}else{k=new Buffer(e)}var o=0;for(var h=0,g=j.length;h<g&&o<e;h++){var d=j[0];var f=Math.min(e-o,d.length);if(m){k+=d.slice(0,f)}else{d.copy(k,o,0,f)}if(f<d.length){j[0]=d.slice(f)}else{j.shift()}o+=f}}}}}}return k}function endReadable(b){var a=b._readableState;if(a.length>0){throw new Error("endReadable called on non-empty stream")}if(!a.endEmitted&&a.calledRead){a.ended=true;process.nextTick(function(){if(!a.endEmitted&&a.length===0){a.endEmitted=true;b.readable=false;b.emit("end")}})}}function forEach(b,d){for(var c=0,a=b.length;c<a;c++){d(b[c],c)}}function indexOf(c,a){for(var d=0,b=c.length;d<b;d++){if(c[d]===a){return d}}return -1};