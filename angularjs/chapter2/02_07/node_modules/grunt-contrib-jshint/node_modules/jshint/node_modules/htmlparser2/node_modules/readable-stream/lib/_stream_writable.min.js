module.exports=Writable;var Buffer=require("buffer").Buffer;Writable.WritableState=WritableState;var util=require("core-util-is");util.inherits=require("inherits");var Stream=require("stream");util.inherits(Writable,Stream);function WriteReq(b,c,a){this.chunk=b;this.encoding=c;this.callback=a}function WritableState(a,d){a=a||{};var c=a.highWaterMark;this.highWaterMark=(c||c===0)?c:16*1024;this.objectMode=!!a.objectMode;this.highWaterMark=~~this.highWaterMark;this.needDrain=false;this.ending=false;this.ended=false;this.finished=false;var b=a.decodeStrings===false;this.decodeStrings=!b;this.defaultEncoding=a.defaultEncoding||"utf8";this.length=0;this.writing=false;this.sync=true;this.bufferProcessing=false;this.onwrite=function(e){onwrite(d,e)};this.writecb=null;this.writelen=0;this.buffer=[];this.errorEmitted=false}function Writable(b){var a=require("./_stream_duplex");if(!(this instanceof Writable)&&!(this instanceof a)){return new Writable(b)}this._writableState=new WritableState(b,this);this.writable=true;Stream.call(this)}Writable.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe. Not readable."))};function writeAfterEnd(c,b,a){var d=new Error("write after end");c.emit("error",d);process.nextTick(function(){a(d)})}function validChunk(e,d,b,a){var c=true;if(!Buffer.isBuffer(b)&&"string"!==typeof b&&b!==null&&b!==undefined&&!d.objectMode){var f=new TypeError("Invalid non-string/buffer chunk");e.emit("error",f);process.nextTick(function(){a(f)});c=false}return c}Writable.prototype.write=function(c,d,a){var e=this._writableState;var b=false;if(typeof d==="function"){a=d;d=null}if(Buffer.isBuffer(c)){d="buffer"}else{if(!d){d=e.defaultEncoding}}if(typeof a!=="function"){a=function(){}}if(e.ended){writeAfterEnd(this,e,a)}else{if(validChunk(this,e,c,a)){b=writeOrBuffer(this,e,c,d,a)}}return b};function decodeChunk(c,a,b){if(!c.objectMode&&c.decodeStrings!==false&&typeof a==="string"){a=new Buffer(a,b)}return a}function writeOrBuffer(g,f,d,e,b){d=decodeChunk(f,d,e);if(Buffer.isBuffer(d)){e="buffer"}var a=f.objectMode?1:d.length;f.length+=a;var c=f.length<f.highWaterMark;if(!c){f.needDrain=true}if(f.writing){f.buffer.push(new WriteReq(d,e,b))}else{doWrite(g,f,a,d,e,b)}return c}function doWrite(f,e,b,c,d,a){e.writelen=b;e.writecb=a;e.writing=true;e.sync=true;f._write(c,d,e.onwrite);e.sync=false}function onwriteError(d,c,b,e,a){if(b){process.nextTick(function(){a(e)})}else{a(e)}d._writableState.errorEmitted=true;d.emit("error",e)}function onwriteStateUpdate(a){a.writing=false;a.writecb=null;a.length-=a.writelen;a.writelen=0}function onwrite(d,f){var c=d._writableState;var b=c.sync;var a=c.writecb;onwriteStateUpdate(c);if(f){onwriteError(d,c,b,f,a)}else{var e=needFinish(d,c);if(!e&&!c.bufferProcessing&&c.buffer.length){clearBuffer(d,c)}if(b){process.nextTick(function(){afterWrite(d,c,e,a)})}else{afterWrite(d,c,e,a)}}}function afterWrite(c,b,d,a){if(!d){onwriteDrain(c,b)}a();if(d){finishMaybe(c,b)}}function onwriteDrain(b,a){if(a.length===0&&a.needDrain){a.needDrain=false;b.emit("drain")}}function clearBuffer(h,g){g.bufferProcessing=true;for(var i=0;i<g.buffer.length;i++){var f=g.buffer[i];var d=f.chunk;var e=f.encoding;var b=f.callback;var a=g.objectMode?1:d.length;doWrite(h,g,a,d,e,b);if(g.writing){i++;break}}g.bufferProcessing=false;if(i<g.buffer.length){g.buffer=g.buffer.slice(i)}else{g.buffer.length=0}}Writable.prototype._write=function(b,c,a){a(new Error("not implemented"))};Writable.prototype.end=function(b,c,a){var d=this._writableState;if(typeof b==="function"){a=b;b=null;c=null}else{if(typeof c==="function"){a=c;c=null}}if(typeof b!=="undefined"&&b!==null){this.write(b,c)}if(!d.ending&&!d.finished){endWritable(this,d,a)}};function needFinish(b,a){return(a.ending&&a.length===0&&!a.finished&&!a.writing)}function finishMaybe(c,b){var a=needFinish(c,b);if(a){b.finished=true;c.emit("finish")}return a}function endWritable(c,b,a){b.ending=true;finishMaybe(c,b);if(a){if(b.finished){process.nextTick(a)}else{c.once("finish",a)}}b.ended=true};